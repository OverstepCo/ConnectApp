<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Connect App</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined">
  <link rel="stylesheet" href="css/framework7.css">
  <link rel="stylesheet" href="css/framework7.bundle.min.css">
  <link rel="stylesheet" href="css/app.css">
</head>

<body>
  <div id="app">
    <div class="panel panel-left panel-cover panel-resizable">
      <div class="block panel-header gradient-background">
        <img src="media/logo.png">
        <h2>Connect</h2>
        <p>Connect App Description</p>
      </div>
      <div class="list no-hairlines" style="margin-top: 10px;">
        <ul>
          <a href="/profile-screen/" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">person</i></div>
              <div class="item-inner">My Profile</div>
            </li>
          </a>
          <a href="#" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">school</i></div>
              <div class="item-inner">Change School</div>
            </li>
          </a>
          <a href="/settings-screen/" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">settings</i></div>
              <div class="item-inner">Settings</div>
            </li>
          </a>
          <a href="#" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">info</i></div>
              <div class="item-inner">About</div>
            </li>
          </a>
          <a href="#" onclick="signOut()" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">cloud_off</i></div>
              <div class="item-inner">Sign Out</div>
            </li>
          </a>
          <a href="/login-screen/" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">cloud</i></div>
              <div class="item-inner">Sign In</div>
            </li>
          </a>
        </ul>
      </div>
    </div>

    <div class="view view-main" data-url="/">
      <div data-page="index" class="page">

        <div class="navbar no-shadow no-harline transparent-background">
          <div id="navbar" class="navbar-inner school-header">
            <div class="left">
              <a class="panel-open link icon-only">
                <i class="material-icons icon">menu</i>
              </a>
            </div>
            <div>
              <h1>School Of Ross</h1>
              <p>32 Members | 12 Groups | 7 Events</p>
            </div>
            <div class="right">
              <a href="/profile-screen/" class="link icon-only">
                <i class="material-icons icon">person</i>
              </a>
            </div>
          </div>
        </div>
        <div class="page-content" style="overflow-x: hidden; background-color: #edeff2">
          <div class="title">Upcoming Events</div>
          <div class="hairline"></div>
          <div data-space-between="0" data-slides-per-view="1" class="swiper-container swiper-init event-swiper">
            <div class="swiper-wrapper">
              <div class="swiper-slide">
                <div class="slide-content">
                  <div class="row">
                    <div class="col">
                      <h4 class="slide-title">Bob Ross Club</h4>
                      <p>Every Wednesday</p>
                      <p>7:30-9</p>
                      <p>Art Room</p>
                    </div>
                    <div class="col slide-content-image"></div>
                  </div>
                </div>
              </div>
              <div class="swiper-slide">
                <div class="slide-content">
                  <h4 class="slide-title">Nature Painting</h4>
                  <p> S M T W T F S</p>
                  <p>7:30-9:00</p>
                  <p>Cafeteria</p>
                </div>
              </div>
              <div class="swiper-slide">
                <div class="slide-content">
                  <h4 class="slide-title">Ross Club</h4>
                  <p>Every Wednesday</p>
                  <p>7:30-9</p>
                  <p>Cafeteria</p>
                </div>
              </div>
              <div class="swiper-slide">
                <div class="slide-content">
                  <h4 class="slide-title">Ross Club</h4>
                  <p>Every Wednesday</p>
                  <p>7:30-9</p>
                  <p>Cafeteria</p>
                </div>
              </div>
            </div>
          </div>
          <div class="card-block">
            <div class="title">Subscribed Chats</div>
            <div class="hairline"></div>
            <div class="list media-list no-margin-bottom no-hairlines no-hairlines-between no-margin-top">
              <ul>
                <li>
                  <a href="#" class="item-link item-content no-chevron">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">Group Chat 1</div>
                        <div class="item-after">12:14</div>
                      </div>
                      <div class="item-text"><b>Jaden Smith: </b>Are we on for Monday night?</div>
                    </div>
                  </a>
                </li>
                <li>
                  <a href="/chat-screen/" class="item-link item-content no-chevron">
                    <div class="item-inner">
                      <div class="item-title-row">
                        <div class="item-title">Group Chat 2</div>
                        <div class="item-after">10:11</div>
                      </div>
                      <div class="item-text"><b>Krombopulos Mike: </b>Here I go killing again!</div>
                    </div>
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="card-block">
            <div class="title">Unsubscribed Chats</div>
            <div class="hairline"></div>

            <div id="school-group-chats-skeleton" class="list media-list skeleton-text no-hairlines no-hairlines-between">
              <ul>
                <li class="item-content skeleton-effect-pulse">
                  <div class="item-media">
                    <div class="skeleton-block" style="width: 40px; height: 40px; border-radius: 50%"></div>
                  </div>
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div class="item-title">This is Title</div>
                    </div>
                    <div class="item-subtitle">Subtitle</div>
                    <div class="item-text">
                      Placeholder text line 1 Text line 2
                    </div>
                  </div>
                </li>
                <li class="item-content skeleton-effect-pulse">
                  <div class="item-media">
                    <div class="skeleton-block" style="width: 40px; height: 40px; border-radius: 50%"></div>
                  </div>
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div class="item-title">This is Title</div>
                    </div>
                    <div class="item-subtitle">Subtitle</div>
                    <div class="item-text">
                      Placeholder text line 1 Text
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <div class="list media-list chevron-center no-margin-bottom no-margin-top no-hairlines no-hairlines-between">
              <ul class="school-group-chats" id="school-group-chats">

              </ul>
            </div>
            <div class="row justify-content-center"><a class="link"><i class="material-icons">keyboard_arrow_down</i></a></div>
          </div>
          <div class="card-block">
            <div class="title">School Members</div>
            <div class="hairline"></div>

            <div class="searchbar searchbar-inline">
              <div class="searchbar-input-wrap row">
                <input class="no-padding" type="search" placeholder="Search List">
                <span class="input-clear-button"></span>
              </div>
            </div>
            <div class="list members-list searchbar-found no-hairlines no-hairlines-between no-margin-top">
              <ul>
                <a href="#" class="item-link no-chevron">
                  <li class="item-content">
                    <div class="item-media"><i class="material-icons gradient-icon">person</i></div>
                    <div class="item-inner">Krombopulos Mike</div>
                  </li>
                </a>
                <a href="#" class="item-link no-chevron">
                  <li class="item-content">
                    <div class="item-media"><i class="material-icons gradient-icon">person</i></div>
                    <div class="item-inner">Jane Smith</div>
                  </li>
                </a>

              </ul>
            </div>
            <!-- Nothing found message -->
            <div class="block searchbar-not-found">
              <div class="block-inner">Nothing found</div>
            </div>
          </div>


        </div>
      </div>
    </div>
  </div>


  <script type="text/javascript" src="js/framework7.bundle.js"></script>
  <script type="text/javascript" src="js/main.js"></script>
  <script type="text/javascript" src="js/chat.js"></script>


  <!-- Firebase stuff-->
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.3/firebase-firestore.js"></script>


  <script>
    var firebaseConfig = {

      apiKey: "AIzaSyBUSM_BAQ81dWuIdGJEyIPWcGul6LQ4HEw",
      authDomain: "connect-proj.firebaseapp.com",
      databaseURL: "https://connect-proj.firebaseio.com",
      projectId: "connect-proj",
      storageBucket: "connect-proj.appspot.com",
      messagingSenderId: "846822998925"

    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    //firebase.auth().signInWithEmailAndPassword("ethandisilvestro@gmail.com", "123456").catch(function(error) {});

    var db = firebase.firestore();
    var User;
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        var displayName = user.displayName;
        var email = user.email;
        var emailVerified = user.emailVerified;
        var photoURL = user.photoURL;
        var isAnonymous = user.isAnonymous;
        var uid = user.uid;
        var providerData = user.providerData;
        console.log(uid);
        User = user;

        loadSchoolChats();
        loadSubscribedChats();

        //close the login screen if it is open
        var currentPage = app.views.main.router.url;
        if (currentPage == "/login-screen/") {
          self.app.views.main.router.navigate('/home/', {
            reloadCurrent: true
          });
        }
        app.preloader.hide();
        // ...
      } else {
        // User is signed out.
        self.app.views.main.router.navigate('/login-screen/', {
          reloadCurrent: true
        });

      }
    });

    function signUp() {
      app.preloader.show();

      var email = document.getElementById("email").value;
      var password = document.getElementById("newpword").value;
      var err = document.getElementById("newerrmsg");
      err.innerHTML = "";

      firebase.auth().createUserWithEmailAndPassword(email, password).catch(function(error) {
        app.preloader.hide();

        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log("Failed to sign up: " + errorMessage);
        err.innerHTML = "Error: " + errorMessage;

      });



    }

    function signIn() {

      app.preloader.show();
      var username = document.getElementById("uname").value;
      var password = document.getElementById("pword").value;
      var err = document.getElementById("errmsg");
      err.innerHTML = "";

      firebase.auth().signInWithEmailAndPassword(username, password).catch(function(error) {
        app.preloader.hide();
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log("Failed to login: " + error.message);
        err.innerHTML = "Error: " + error.message;
      });

      console.log(app.views.main.router.url);
    }

    function signOut() {
      firebase.auth().signOut().then(function() {
        // Sign-out successful.
      }).catch(function(error) {
        console.log("Failed to sign out: " + error.message);
      });
    }

    //firestore stuff (chat things)
    function loadSchoolChats() {
      //TODO clear the currently loaded chats if there are any
      db.collection("users").doc(User.uid).get().then(function(user) {
        db.collection("school").doc(user.get("school")).collection("chats").get().then(function(querySnapshot) {
          querySnapshot.forEach(function(doc) {
            //this loop runs once for every chat room in the school
            var ls = document.getElementById("school-group-chats");
            var li = document.createElement('li')
            li.innerHTML = '<a href="#" class="item-link item-content">\
            <div class="item-inner">\
              <div class="item-title-row">\
                <div class="item-title">' + doc.get("name") + '</div>\
              </div>\
              <div class="item-subtitle">' + doc.get("numberOfMembers") + ' Members</div>\
              <div class="item-text">' + doc.get("description") + '</div>\
            </div>\
          </a>';
            ls.appendChild(li);


            //if any of these dont exist in the database they return null or undefined
          });
          var skeleton = document.getElementById('school-group-chats-skeleton');
          skeleton.parentNode.removeChild(skeleton);

        });
      });
    }

    function loadSubscribedChats() {
      db.collection("users").doc(User.uid).collection("chats").get().then(function(querySnapshot) {
        querySnapshot.forEach(function(doc) {
          //this loop runs once for every chat room the current user is subbscribed to

          db.collection("school").doc(doc.get("school") + "").collection("chats").doc(doc.id).get().then(function(chat) {
            console.log(doc.id);
            console.log(chat.get("name"));
            //if any of these dont exist in the database they return null or undefined
          });
        });
      });
    }

    //managing user data (subscribing and unsubscribing from chats and stuff like that)
    function subscribeToChat(chatID, chatSchool) {
      console.log("subscribing to chat")
      db.collection("users").doc(User.uid).collection("chats").doc(chatID).set({
        school: chatSchool
      });
    }

    function unsubscribeFromChat(chatID, chatSchool) {
      db.collection("users").doc(User.uid).collection("chats").doc(chatID).update({
        school: firebase.firestore.FieldValue.delete()
      });
      db.collection("users").doc(User.uid).collection("chats").doc(chatID).delete().then(function() {
        console.log("successfully unsubscribed from chat");
      }).catch(function(error) {
        console.error("Error removing document: ", error);
      });;
    }


    function addMessage() {
      db.collection("messages").add({
          name: firebase.auth().currentUser.uid,
          profilePicUrl: "https://lh4.googleusercontent.com/-bDz3d4hCLzA/AAAAAAAAAAI/AAAAAAAAAEk/xwohCLOzw7c/photo.jpg",
          text: document.getElementById("messagebar").value,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(function(docRef) {
          console.log("Document written with ID: ", docRef.id);
        })
        .catch(function(error) {
          console.error("Error adding document: ", error);
        });
    }
  </script>
</body>

</html>