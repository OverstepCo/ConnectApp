<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Connect App</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined">
  <link rel="stylesheet" href="css/framework7.css">
  <link rel="stylesheet" href="css/framework7.bundle.min.css">
  <link rel="stylesheet" href="css/app.css">
</head>

<body>
  <div id="app">
    <div class="panel panel-left panel-cover panel-resizable">
      <div class="block panel-header gradient-background">
        <img src="media/logo.png">
        <h2>Connect</h2>
        <p>Connect App Description</p>
      </div>
      <div class="list no-hairlines" style="margin-top: 10px;">
        <ul>
          <a href="/profile-screen/" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">person</i></div>
              <div class="item-inner">My Profile</div>
            </li>
          </a>
          <a href="#" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">school</i></div>
              <div class="item-inner">Change School</div>
            </li>
          </a>
          <a href="/settings-screen/" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">settings</i></div>
              <div class="item-inner">Settings</div>
            </li>
          </a>
          <a href="#" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">info</i></div>
              <div class="item-inner">About</div>
            </li>
          </a>
          <a href="#" onclick="signOut()" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">cloud_off</i></div>
              <div class="item-inner">Sign Out</div>
            </li>
          </a>
          <a href="/login-screen/" class="panel-close item-link no-chevron">
            <li class="item-content">
              <div class="item-media"><i class="material-icons gradient-icon">cloud</i></div>
              <div class="item-inner">Sign In</div>
            </li>
          </a>
        </ul>
      </div>
    </div>

    <div class="view view-main" data-url="/">
      <div data-page="index" class="page">

        <div class="navbar no-shadow no-harline transparent-background">
          <div id="navbar" class="navbar-inner school-header">
            <div class="left">
              <a class="panel-open link icon-only">
                <i class="material-icons icon">menu</i>
              </a>
            </div>
            <div>
              <h1 id="school-name">My School</h1>
              <p id="school-description">32 Members | 12 Groups | 7 Events</p>
            </div>
            <div class="right">
              <a href="/profile-screen/" class="link icon-only">
                <i class="material-icons icon">person</i>
              </a>
            </div>
          </div>
        </div>
        <div class="page-content" style="overflow-x: hidden; background-color: #edeff2">
          <div class="row title justify-items-left">
            <div>Upcoming Events</div>
            <div class="left">
              <i onclick="swipeLeft()" class="material-icons">keyboard_arrow_left</i>
              <i onclick="swipeRight()" class="material-icons">keyboard_arrow_right</i>
            </div>
          </div>
          <div id="event-swiper-wrapper" data-space-between="0" data-slides-per-view="1" class="swiper-container event-swiper">
            <div id="event-swiper" class="swiper-wrapper">


            </div>
          </div>
          <div class="card-block no-margin-top">
            <div class="title">Subscribed Chats</div>
            <div class="hairline"></div>

            <div id="subscribed-chats-skeleton" class="list media-list skeleton-text no-hairlines no-hairlines-between no-margin">
              <ul>
                <li class="item-content skeleton-effect-pulse">
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div class="item-title">This is Title</div>
                    </div>
                    <div class="item-text">
                      Placeholder text line 1 Text line 2
                    </div>
                  </div>
                </li>
                <li class="item-content skeleton-effect-pulse">
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div class="item-title">This is Title</div>
                    </div>
                    <div class="item-text">
                      Placeholder text line 1 Text
                    </div>
                  </div>
                </li>
              </ul>
            </div>

            <div class="list media-list no-margin-bottom no-hairlines no-hairlines-between no-margin-top">
              <ul id="subscribed-chats">

              </ul>
            </div>
          </div>
          <div class="card-block">
            <div class="title">Unsubscribed Chats</div>
            <div class="hairline"></div>

            <div id="school-group-chats-skeleton" class="list media-list skeleton-text no-hairlines no-hairlines-between">
              <ul>
                <li class="item-content skeleton-effect-pulse">
                  <div class="item-media">
                    <div class="skeleton-block" style="width: 40px; height: 40px; border-radius: 50%"></div>
                  </div>
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div class="item-title">This is Title</div>
                    </div>
                    <div class="item-subtitle">Subtitle</div>
                    <div class="item-text">
                      Placeholder text line 1 Text line 2
                    </div>
                  </div>
                </li>
                <li class="item-content skeleton-effect-pulse">
                  <div class="item-media">
                    <div class="skeleton-block" style="width: 40px; height: 40px; border-radius: 50%"></div>
                  </div>
                  <div class="item-inner">
                    <div class="item-title-row">
                      <div class="item-title">This is Title</div>
                    </div>
                    <div class="item-subtitle">Subtitle</div>
                    <div class="item-text">
                      Placeholder text line 1 Text
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <div class="list media-list chevron-center no-margin-bottom no-margin-top no-hairlines no-hairlines-between">
              <ul class="school-group-chats" id="school-group-chats">

              </ul>
            </div>
            <div class="row justify-content-center"><a class="link"><i class="material-icons">expand_more</i></a></div>
          </div>
          <div class="card-block">
            <div class="title">School Members</div>
            <div class="hairline"></div>

            <div class="searchbar searchbar-inline">
              <div class="searchbar-input-wrap row">
                <input class="no-padding" type="search" placeholder="Search List">
                <span class="input-clear-button"></span>
              </div>
            </div>
            <div class="list members-list searchbar-found no-hairlines no-hairlines-between no-margin-top">
              <ul>
                <a href="#" class="item-link no-chevron">
                  <li class="item-content">
                    <div class="item-media"><i class="material-icons gradient-icon">person</i></div>
                    <div class="item-inner">Krombopulos Mike</div>
                  </li>
                </a>
                <a href="#" class="item-link no-chevron">
                  <li class="item-content">
                    <div class="item-media"><i class="material-icons gradient-icon">person</i></div>
                    <div class="item-inner">Jane Smith</div>
                  </li>
                </a>

              </ul>
            </div>
            <!-- Nothing found message -->
            <div class="block searchbar-not-found">
              <div class="block-inner">Nothing found</div>
            </div>
          </div>


        </div>
      </div>
    </div>
  </div>


  <script type="text/javascript" src="js/framework7.bundle.js"></script>
  <script type="text/javascript" src="js/main.js"></script>
  <script type="text/javascript" src="js/chat.js"></script>


  <!-- Firebase stuff-->
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.4/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.3/firebase-firestore.js"></script>


  <script>
    var firebaseConfig = {

      apiKey: "AIzaSyBUSM_BAQ81dWuIdGJEyIPWcGul6LQ4HEw",
      authDomain: "connect-proj.firebaseapp.com",
      databaseURL: "https://connect-proj.firebaseio.com",
      projectId: "connect-proj",
      storageBucket: "connect-proj.appspot.com",
      messagingSenderId: "846822998925"

    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    //firebase.auth().signInWithEmailAndPassword("ethandisilvestro@gmail.com", "123456").catch(function(error) {});
    var db = firebase.firestore();
    var User; //TODO change this to referance the custom userdata intead of firebases auth user
    var uid;






    /**********AUTHENTICATION**********/

    firebase.auth().onAuthStateChanged(function(user) { //This function runs every time the users authentication state changes (eg. the user signs in or out)
      if (user) { // User is signed in.
        uid = user.uid;
        console.log(uid);
        db.collection("users").doc(uid).get().then(function(user) {
          User = {
            uid: uid,
            firstName: user.get("firstName"),
            lastName: user.get("lastName"),
            school: user.get("school"),
            firstName: user.get("picUrl"),
            fullName: function() {
              return this.firstName + " " + this.lastName;
            }
          }
          updateHeaderInfo(User);
          loadSchoolEvents();
          loadSchoolChats();
          loadSubscribedChats();
          addMessage("school of ross", "room1", "testmessage");
          loadChatMessages("school of ross", "room1");
        });

        //close the login screen if it is open
        var currentPage = app.views.main.router.url;
        if (currentPage == "/login-screen/") {
          self.app.views.main.router.navigate('/home/', {
            reloadCurrent: true
          });
        }
        //self.app.views.main.router.navigate('/home/', {
        //  reloadCurrent: true
        //});
        app.preloader.hide();
        // ...
      } else { //User is signed out.
        self.app.views.main.router.navigate('/login-screen/', {
          reloadCurrent: true
        });
      }
    });

    function signUp() {
      app.preloader.show();

      var email = document.getElementById("email").value;
      var password = document.getElementById("newpword").value;
      var err = document.getElementById("newerrmsg");
      err.innerHTML = "";

      firebase.auth().createUserWithEmailAndPassword(email, password).catch(function(error) {
        app.preloader.hide();

        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log("Failed to sign up: " + errorMessage);
        err.innerHTML = "Error: " + errorMessage;

      });
    }

    function signIn() {
      app.preloader.show();
      var username = document.getElementById("uname").value;
      var password = document.getElementById("pword").value;
      var err = document.getElementById("errmsg");
      err.innerHTML = "";
      firebase.auth().signInWithEmailAndPassword(username, password).catch(function(error) {
        app.preloader.hide();
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        console.log("Failed to login: " + error.message);
        err.innerHTML = "Error: " + error.message;
      });
      console.log(app.views.main.router.url);
    }

    function signOut() {
      firebase.auth().signOut().then(function() {
        // Sign-out successful.
      }).catch(function(error) {
        console.log("Failed to sign out: " + error.message);
      });
    }

    function updateUserData() {
      var firstName = document.getElementById("update-first-name");
      var lastName = document.getElementById("update-last-name");
      var profilePicUrl = document.getElementById("update-profile-pic");

    }





    /**********EVENTS**********/

    //loads school events from the database
    function loadSchoolEvents() {
      db.collection("school").doc(User.school).collection("event").get().then(function(querySnapshot) {
        querySnapshot.forEach(function(doc) {
          //this loop runs once for every event in the current school
          showSchoolEvent(doc.get("name"), doc.get("image"), doc.get("day"), doc.get("time"), doc.get("location"), doc.get("description"), doc.get("guests"));
        });
      });
    }

    //adds a event so the school database with the provided data
    function addSchoolEvent(name, image, day, time, location, description, guests) {
      db.collection("school").doc(User.school).collection("event").add({
        name: name,
        image,
        day,
        time,
        location,
        description,
        guests,
        owner: User.uid
      });

    }

    //Shows an event on the local UI.
    function showSchoolEvent(name, image, day, time, location, description, guests) {

      app.swiper.destroy('.swiper-container');

      var swiper = document.getElementById('event-swiper');
      var event = document.createElement('div');
      event.classList.add("swiper-slide");
      event.innerHTML = '<div class="slide-content">\
      <div class="row" style="margin-bottom: 0">\
      <div class="col-33">\
      <div class="slide-image" style="background-image: url(' + image + ');"></div>\
      </div>\
      <div class="col-66">\
      <div class="slide-text">\
      <h4 class="slide-title">' + name + '</h4>\
      <p>' + day + '</p>\
      <p>' + time + ' | ' + location + '</p>\
      </div>\
      </div>\
      </div>\
      <div class="collapsible">\
      <div class="collapsible-content">' + description + '</div>\
      <div style="background-color: white">\
      <div class="hairline"></div>\
      </div>\
      </div>\
      <div class=" row slide-guests">\
      <div class="row left" style="display:flex;justify-content: center;align-items: center;">\
      <div class="col img" style="background-image: url(https://cdn.mos.cms.futurecdn.net/Rmtq8KDLagPDutJTp5ZViE.jpg)"></div>\
      <div class="col img" style="background-image: url(https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTyMQl7f1VtadBUijAqRzqzM0KG0cYEoA5aXeqLmuzUQUJENZHN5A)"></div>\
      <p>+3 more</p>\
      </div>\
      <div class="right"><a class="link collapsible-toggle"><i class="material-icons">expand_more</i></a></div>\
      </div>\
      </div>';

      swiper.appendChild(event);
      app.swiper.create('.swiper-container');

      var collToggle = document.getElementsByClassName("collapsible-toggle");

      collToggle[collToggle.length - 1].addEventListener("click", function() {
        this.classList.toggle("active");
        var coll = this.parentElement.parentElement.previousElementSibling;
        coll.classList.toggle("expanded");
      });
      updateSwiper();

    }





    /**********CHATS**********/

    //Loads all the chats in the users current school from the database and displays them
    function loadSchoolChats() {
      //TODO clear the currently loaded chats if there are any
      db.collection("school").doc(User.school).collection("chats").get().then(function(querySnapshot) {
        querySnapshot.forEach(function(doc) {
          //this loop runs once for every chat room in the school
          var ls = document.getElementById("school-group-chats");
          var li = document.createElement('li')
          li.innerHTML = '<a href="#" class="item-link item-content">\
            <div class="item-inner">\
              <div class="item-title-row">\
                <div class="item-title">' + doc.get("name") + '</div>\
              </div>\
              <div class="item-subtitle">' + doc.get("numberOfMembers") + ' Members</div>\
              <div class="item-text">' + doc.get("description") + '</div>\
            </div>\
          </a>';
          ls.appendChild(li);
          //if any of these dont exist in the database they return null or undefined
        });
        var skeleton = document.getElementById('school-group-chats-skeleton');
        skeleton.parentNode.removeChild(skeleton);
      });
    }

    //Loads all the chats that the user is subscribed to
    function loadSubscribedChats() {

      db.collection("users").doc(User.uid).collection("chats").get().then(function(querySnapshot) {
        querySnapshot.forEach(function(doc) {
          //this loop runs once for every chat room the current user is subscribed to
          db.collection("school").doc(doc.get("school") + "").collection("chats").doc(doc.id).get().then(function(chat) {
            db.collection("school").doc(doc.get("school") + "").collection("chats").doc(doc.id).collection("messages").orderBy("timeStamp", "desc").limit(1).get().then(function(messages) {
              messages.forEach(function(message) {
                var ls = document.getElementById("subscribed-chats");
                var li = document.createElement('li');
                li.innerHTML = '<a onclick="(loadChat(\'' + doc.id + ',' + doc.get("school") + '\'))" class="item-link item-content no-chevron">\
              <div class="item-inner">\
                <div class="item-title-row">\
                  <div class="item-title">' + chat.get("name") + '</div>\
                  <div class="item-after">' + '12:14' + '</div>\
                </div>\
                <div class="item-text"><b>' + message.get("userID") + ': </b>' + message.get("text") + '</div>\
              </div>\
            </a>';
                ls.appendChild(li);
                //if any of these dont exist in the database they return null or undefined
              });
            });
          });
        });
      });
      var skeleton = document.getElementById('subscribed-chats-skeleton');
      skeleton.parentNode.removeChild(skeleton);
    }

    //Adds a message to the specified chatroom
    function addMessage(school, chatID, message) {

      db.collection("school").doc(school).collection("chats").doc(chatID).collection("messages").add({
          userID: User.uid,
          profilePicUrl: "https://lh4.googleusercontent.com/-bDz3d4hCLzA/AAAAAAAAAAI/AAAAAAAAAEk/xwohCLOzw7c/photo.jpg", //TODO change this to the users profile pic
          text: message, //document.getElementById("messagebar").value, //not sure if this is the best way to do this
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(function(docRef) {
          console.log("Document written with ID: ", docRef.id);
        })
        .catch(function(error) {
          console.error("Error adding document: ", error);
        });
    }

    function addMessage() {
      db.collection("messages").add({
          name: firebase.auth().currentUser.uid,
          profilePicUrl: "https://lh4.googleusercontent.com/-bDz3d4hCLzA/AAAAAAAAAAI/AAAAAAAAAEk/xwohCLOzw7c/photo.jpg",
          text: document.getElementById("messagebar").value,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(function(docRef) {
          console.log("Document written with ID: ", docRef.id);
        })
        .catch(function(error) {
          console.error("Error adding document: ", error);
        });
    }

    //subscribes the user to the specified chat
    //TODO get the chat school variable dynamicly
    function subscribeToChat(chatID, chatSchool) {
      console.log("subscribing to chat")
      db.collection("users").doc(User.uid).collection("chats").doc(chatID).set({
        school: chatSchool
      });
    }

    //unsubscribes the user from the specified chat
    function unsubscribeFromChat(chatID, chatSchool) {
      db.collection("users").doc(User.uid).collection("chats").doc(chatID).update({
        school: firebase.firestore.FieldValue.delete()
      });
      db.collection("users").doc(User.uid).collection("chats").doc(chatID).delete().then(function() {
        console.log("successfully unsubscribed from chat");
      }).catch(function(error) {
        console.error("Error removing document: ", error);
      });;
    }

    function loadChat(chatID, chatSchool) {
      self.app.views.main.router.navigate('/chat-screen/');
      console.log(app.views.main.router.url);
      document.getElementById("group-name").innerinnerHTML = "GROUP NAME";

    }

    function previewChat(chatID) {
      self.app.views.main.router.navigate('/preview-chat-screen/');
    }
  </script>
</body>

</html>